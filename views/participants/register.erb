<!DOCTYPE html>
<html lang="<%= @lang || session[:locale] || 'es' %>">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= t('participant.register.title') %> - <%= @event['event_type']['name'] %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    <style>
        .form-container { max-width: 600px; margin: 2rem auto; padding: 2rem; }
        .event-info { background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; }
        .pricing-info { background: #e7f3ff; padding: 1rem; border-radius: 6px; margin: 1rem 0; }
        .savings { background: #d4edda; color: #155724; padding: 0.5rem; border-radius: 4px; }
        .error { color: #dc3545; font-size: 0.875rem; }
        .loading { opacity: 0.6; pointer-events: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="form-container">
            <!-- Event Information -->
            <div class="event-info text-center">
                <h1><%= @event['event_type']['name'] %></h1>
                <p class="mb-2">
                    <i class="fas fa-calendar"></i>
                    <%= @event['human_date'] %> <%= @event['human_time'] %>
                </p>
                <p class="mb-0">
                    <i class="fas fa-map-marker-alt"></i>
                    <%= [@event['place'], @event['address'], @event['city']].compact.join(', ') %>
                </p>
            </div>

            <!-- Registration Form -->
            <form id="registrationForm">
                <input type="hidden" name="event_id" value="<%= @event['id'] %>">
                
                <!-- Alert Messages -->
                <div id="alertContainer"></div>
                
                <% if @event['is_sold_out'] %>
                <div class="alert alert-warning">
                    <%= t('participant.alert.sold_out') %>
                </div>
                <% end %>
                
                <% if @event['registration_ended'] %>
                <div class="alert alert-danger">
                    <%= t('participant.alert.registration_ended') %>
                </div>
                <% else %>

                <!-- Personal Information -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label"><%= t('participant.labels.fname') %> *</label>
                        <input type="text" class="form-control" name="fname" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label"><%= t('participant.labels.lname') %> *</label>
                        <input type="text" class="form-control" name="lname" required>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label"><%= t('participant.labels.email') %> *</label>
                    <input type="email" class="form-control" name="email" required>
                    <div class="form-text"><%= t('participant.labels.email_hint') %></div>
                </div>

                <div class="mb-3">
                    <label class="form-label"><%= t('participant.labels.company_name') %></label>
                    <input type="text" class="form-control" name="company_name">
                </div>

                <div class="mb-3">
                    <label class="form-label"><%= t('participant.labels.address') %> *</label>
                    <input type="text" class="form-control" name="address" required>
                </div>

                <!-- Quantity Selection -->
                <div class="mb-3">
                    <label class="form-label"><%= t('participant.labels.quantity') %></label>
                    <select class="form-control" name="quantity" id="quantitySelect">
                        <% (1..6).each do |qty| %>
                        <option value="<%= qty %>"><%= qty %> <%= qty == 1 ? t('participant.seat') : t('participant.seats') %></option>
                        <% end %>
                    </select>
                    <div id="pricingInfo" class="pricing-info" style="display: none;">
                        <div id="priceDetails"></div>
                        <div id="savingsInfo" class="savings" style="display: none;"></div>
                    </div>
                </div>

                <% if @event['ask_for_coupons_code'] %>
                <div class="mb-3">
                    <label class="form-label"><%= t('participant.labels.referer_code') %></label>
                    <input type="text" class="form-control" name="referer_code" id="refererCode">
                    <div id="refererMessage" class="form-text"></div>
                </div>
                <% end %>

                <div class="mb-3">
                    <label class="form-label"><%= t('participant.labels.phone') %></label>
                    <input type="tel" class="form-control" name="phone">
                </div>

                <div class="mb-3">
                    <label class="form-label"><%= t('participant.labels.notes') %></label>
                    <textarea class="form-control" name="notes" rows="3"></textarea>
                </div>

                <!-- Terms and Conditions -->
                <div class="mb-3">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" name="accept_terms" id="acceptTerms" required>
                        <label class="form-check-label" for="acceptTerms">
                            * He leído y aceptado la <a href="/<%= @lang %>/politicas-de-privacidad" target="_blank">política de privacidad</a>
                        </label>
                    </div>
                </div>

                <!-- reCAPTCHA -->
                <div class="mb-3">
                    <div class="g-recaptcha" data-sitekey="<%= ENV['RECAPTCHA_SITE_KEY'] %>"></div>
                </div>

                <!-- Submit Button -->
                <div class="text-center">
                    <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                        <% if @event['community_event'] %>
                            <%= t('participant.button.register') %>
                        <% else %>
                            <%= t('participant.button.buy') %>
                        <% end %>
                    </button>
                </div>

                <% end %>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const eventId = '<%= @event['id'] %>';
        const pricingData = <%= @pricing_data.to_json %>;
        
        // Form elements
        const form = document.getElementById('registrationForm');
        const quantitySelect = document.getElementById('quantitySelect');
        const pricingInfo = document.getElementById('pricingInfo');
        const priceDetails = document.getElementById('priceDetails');
        const savingsInfo = document.getElementById('savingsInfo');
        const refererCode = document.getElementById('refererCode');
        const refererMessage = document.getElementById('refererMessage');
        const submitBtn = document.getElementById('submitBtn');
        const alertContainer = document.getElementById('alertContainer');

        // Load pricing info from server-provided data
        function loadPricingInfo(quantity = 1) {
            const data = pricingData[quantity];
            if (!data) {
                console.error('No pricing data for quantity:', quantity);
                return;
            }
            
            pricingInfo.style.display = 'block';
            priceDetails.innerHTML = `
                ${quantity} × $${data.unit_price} ${data.currency} = $${data.total_price} ${data.currency}
            `;
            
            if (data.savings > 0) {
                const savingTemplate = '<%= t('participant.saving').gsub('${saving}', 'SAVING_PLACEHOLDER') %>';
                savingsInfo.innerHTML = savingTemplate.replace('SAVING_PLACEHOLDER', data.savings);
                savingsInfo.style.display = 'block';
            } else {
                savingsInfo.style.display = 'none';
            }
        }

        // Event listeners
        quantitySelect.addEventListener('change', function() {
            loadPricingInfo(this.value);
        });

        if (refererCode) {
            refererCode.addEventListener('input', function() {
                if (this.value.trim()) {
                    refererMessage.textContent = '<%= t('participant.referer_code_message') %>';
                } else {
                    refererMessage.textContent = '';
                }
            });
        }

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            submitRegistration();
        });

        function showAlert(message, type = 'danger') {
            alertContainer.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }

        function submitRegistration() {
            const recaptchaResponse = grecaptcha.getResponse();
            if (!recaptchaResponse) {
                showAlert('<%= t('participant.error.recaptcha_required') %>');
                return;
            }

            // Show loading state
            form.classList.add('loading');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<%= t('participant.button.submitting') %>...';

            const formData = new FormData(form);
            formData.append('recaptcha_token', recaptchaResponse);

            fetch(`/events/${eventId}/participants/register`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error || data.errors) {
                    const errorMessage = data.error || data.errors.join(', ');
                    showAlert(errorMessage);
                    grecaptcha.reset();
                } else {
                    // Success - redirect to confirmation page
                    const confirmUrl = `/events/${eventId}/participant_confirmed?free=${data.free}&api=1`;
                    window.location.href = confirmUrl;
                }
            })
            .catch(error => {
                console.error('Registration error:', error);
                showAlert('<%= t('participant.error.registration_failed') %>');
                grecaptcha.reset();
            })
            .finally(() => {
                // Remove loading state
                form.classList.remove('loading');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<% if @event['community_event'] %><%= t('participant.button.register') %><% else %><%= t('participant.button.buy') %><% end %>';
            });
        }

        // Load initial pricing
        loadPricingInfo(1);
    </script>
</body>
</html>
<%
# Generic banner component for home page
# Usage: <%= erb :'home/_banner', locals: { section_key: 'banner' }
#
# Content field should contain JSON with the following structure:
# {
#   "text": "Banner HTML content",
#   "image": "banner-image.webp",
#   "image_alt": "Banner image",
#   "cta_url": "https://example.com",
#   "background_color": "#d17e1f",
#   "text_color": "#ffffff",
#   "button_bg_color": "#d17e1f",
#   "button_text_color": "#ffffff",
#   "button_border_color": "#ffffff"
# }
# Title field is used only to show/hide the banner (if empty, banner won't display)

require 'json'

section_key = locals[:section_key] || 'banner'

banner_data = section_data(@page, section_key, {
  title: '',
  content: '{}',
  cta_text: ''
})

title = banner_data[:title]
cta_text = banner_data[:cta_text]
 
# Parse JSON from content field
begin
  config = JSON.parse(banner_data[:content] || '{}')
rescue JSON::ParserError
  # Fallback if content is not valid JSON - treat as plain text
  config = { 'text' => banner_data[:content] }
end

content = config['text'] || ''
image_url = config['image'] || 'webinaraniversario.webp'
image_alt = config['image_alt'] || 'Banner'
cta_url = config['cta_url'] || '#'
background_color = config['background_color'] || '#d17e1f'
text_color = config['text_color'] || '#ffffff'
button_bg_color = config['button_bg_color'] || background_color
button_text_color = config['button_text_color'] || '#ffffff'
button_border_color = config['button_border_color'] || '#ffffff'

# Handle both full S3 URLs and simple filenames
if image_url.start_with?('http')
  # Full URL - convert S3 to CDN
  img_src2 = replace_s3_with_cdn(image_url)
  # Try to get webp version by replacing extension
  img_src1 = img_src2.sub(/\.(png|jpg|jpeg)$/i, '.webp')
else
  # Simple filename - use cdn() helper
  image_base = image_url.sub(/\.(webp|png|jpg|jpeg)$/i, '')
  image_ext = image_url[/\.(webp|png|jpg|jpeg)$/i, 1] || 'webp'
  img_src1 = cdn("#{image_base}.webp")
  img_src2 = cdn("#{image_base}.#{image_ext == 'webp' ? 'png' : image_ext}")
end

# Only show banner if we have a title
if title.to_s != ''
%>
<section id="<%= section_key %>" class="mb-4">
  <div class="container-fluid banner-section">
    <div class="row" style="background-color: <%= background_color %>;">
      <div class="col-12 col-sm-4 d-flex align-items-end p-0">
        <a href="<%= cta_url %>" rel="noopener noreferrer" class="academia__link">
            <source srcset="<%= img_src1 %>" type="image/webp"/>
            <img
              src="<%= img_src2 %>"
              class="academia__img"
              alt="<%= image_alt %>"
            />
        </a>
      </div>
      <div class="col-8 col-sm-5 d-flex justify-content-center align-items-center">
        <div class="banner text-center" style="color: <%= text_color %>;"><%= content %></div>
      </div>
      <div class="col-3 d-flex justify-content-center align-items-center">
          <% if cta_text.to_s != '' %>
            <a class="my-secondary-button banner-cta-button text-center p-2" style="background-color: <%= button_bg_color %>;color: <%= button_text_color %>;border-color: <%= button_border_color %>;" href="<%= cta_url %>">
              <%= cta_text %>
            </a>
          <% end %>
      </div>
    </div>
  </div>
</section>
<% end %>